# 鼻歌リズム入力システム設計

## 概要
鼻歌（録音またはテキスト入力）から音符・休符のリズムパターンを抽出し、五線譜上で編集・整形できるシステム。

## 主要機能

### 1. リズム入力機能
- **録音入力**: マイクから鼻歌を録音し、音の有無とタイミングを検出
- **テキスト入力**: 「トゥー」「ダッ」などのオノマトペからリズムを生成
- **検出項目**:
  - 音の開始タイミング
  - 音の持続時間
  - 休符の位置と長さ
  - ※この段階では音高（ピッチ）は無視

### 2. リズム表示機能
- 五線譜上にリズムを可視化
- 音符の種類（全音符、二分音符、四分音符、八分音符など）を自動判定
- 休符も同様に表示
- 単音楽器想定（和音なし）

### 3. リズム編集機能
- **小節設定**: 拍子記号の指定（4/4、3/4など）
- **コード進行指定**: 各小節にコードネームを割り当て
- **リズム削除**: 五線上の音符・休符を選択して削除
- **リズム追加**: 既存のリズムに新しいリズムを追記

## 明確にすべき技術的詳細

### 1. 録音入力について
- **使用技術**: Web Audio API / MediaRecorder API?
- **サンプリングレート**: 44.1kHz? 48kHz?
- **音声解析方法**:
  - 振幅ベースの検出（しきい値方式）
  - エンベロープ検出
  - オンセット検出アルゴリズム
- **ノイズ対策**: どの程度のフィルタリングが必要か?

### 2. テキスト入力について（確定仕様）
- **入力形式**: `「トゥーダッタ」`のように連続したカタカナ
  - スペースは休符として解釈
  - 例: `「トゥー ダッタ」` → 長い音、休符、短い音2つ
- **音価の決定方法**:
  - 文字数ベースで音の長さを決定
  - 連続する音（「ー」を含む）の文字数が相対的な長さを表現
  - 例: 「トゥー」(3文字) → 「ダッ」(2文字)より長い音

### 3. リズム量子化（確定仕様）
- **グリッド解像度**: 16分音符を最小単位として設定
- **量子化アルゴリズム**: 最近傍グリッドへのスナップ
- **テンポ**: BPM指定可能（デフォルト120）、UI上で変更可能

### 4. 五線譜描画
- **使用ライブラリ候補**:
  - VexFlow（楽譜描画）
  - abcjs（ABC記法ベース）
  - 自作SVG描画
- **表示要素**:
  - ト音記号 / ヘ音記号の選択
  - 拍子記号
  - 小節線
  - 音符・休符（符尾、符鉤、連桁の処理）

### 5. データ構造
```typescript
// リズムデータの構造案
interface RhythmNote {
  id: string;
  startTime: number;  // 秒またはビート単位
  duration: number;   // 秒またはビート単位
  isRest: boolean;    // 休符フラグ
}

interface Measure {
  id: string;
  timeSignature: { numerator: number; denominator: number };
  chord?: string;  // コードネーム（例: "C", "Am7"）
  notes: RhythmNote[];
}

interface RhythmSequence {
  tempo: number;  // BPM
  measures: Measure[];
}
```

### 6. UI設計
- **レイアウト**:
  - 入力エリア（録音ボタン or テキストボックス）
  - 五線譜表示エリア
  - 編集コントロール（小節分割、コード入力、削除ボタンなど）
- **インタラクション**:
  - 音符のクリック選択
  - ドラッグ&ドロップでの移動・コピー
  - 右クリックメニュー
- **再生機能**: 入力したリズムを音で確認できるか?

### 7. 技術スタック候補
- **フロントエンド**: React / Vue / Vanilla JS
- **音声処理**: Web Audio API
- **楽譜描画**: VexFlow
- **状態管理**: Redux / Zustand / Context API
- **言語**: TypeScript推奨

## 開発フェーズ案

### Phase 1: 基本リズム入力
- テキスト入力からのリズム生成
- 簡易的な五線譜表示（VexFlowを使用）
- 基本的なデータ構造の実装

### Phase 2: 録音機能
- マイク入力の実装
- 音声解析とリズム検出
- 量子化処理

### Phase 3: 編集機能
- 小節分割機能
- コード進行入力UI
- 音符の削除・追加

### Phase 4: 高度な機能
- リズムの再生機能
- エクスポート（MIDI / MusicXML）
- undo/redo機能

## 確定仕様まとめ

1. **プラットフォーム**: Webアプリケーション
2. **テキスト入力形式**:
   - 「トゥーダッタ」形式（連続カタカナ）
   - スペース = 休符
   - 文字数 = 音の相対的な長さ
3. **優先実装**: テキスト入力機能を先行実装、録音機能は後フェーズ
4. **拍子・テンポ**: UI上で変更可能（初期値: 4/4、BPM 120）
5. **再生機能**: 必須（変更した拍・テンポに対応）
6. **技術スタック**: TypeScript + React + VexFlow + Web Audio API

## 実装優先順位

### Phase 1: コア機能（MVP）
1. テキストパーサー（カタカナ → リズムデータ）
2. リズム量子化ロジック
3. 五線譜描画（VexFlow）
4. リズム再生機能（Web Audio API）

### Phase 2: 編集機能
1. 小節設定UI（拍子記号変更）
2. テンポ変更UI
3. 音符削除機能
4. リズム追加機能
5. コード進行入力

### Phase 3: 拡張機能
1. 録音からのリズム検出
2. データ保存・読込
3. エクスポート機能
