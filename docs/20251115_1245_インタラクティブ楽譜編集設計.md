# ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ¥½è­œç·¨é›†è¨­è¨ˆï¼ˆPhase 3ï¼‰

## Phase 1 & 2ã®æŒ¯ã‚Šè¿”ã‚Š

### Phase 1: ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
- **å•é¡Œ**: æ–‡å­—æ•°ãƒ™ãƒ¼ã‚¹ã§ã¯æ­£ç¢ºãªãƒªã‚ºãƒ è¡¨ç¾ãŒå›°é›£
- **çµè«–**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã¨ã®ã‚®ãƒ£ãƒƒãƒ—ãŒå¤§ãã„

### Phase 2: éŒ²éŸ³å…¥åŠ›
- **å•é¡Œ**: ã‚ªãƒ³ã‚»ãƒƒãƒˆæ¤œå‡ºã®ç²¾åº¦ã€ãƒã‚¤ã‚ºå‡¦ç†ã®è¤‡é›‘ã•
- **çµè«–**: æŠ€è¡“çš„ã«ã¯å¯èƒ½ã ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¨ã—ã¦ä¸å®‰å®š

## Phase 3: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ¥½è­œç·¨é›†

### ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
**ã€Œè¦‹ãŸã¾ã¾ã€è§¦ã£ãŸã¾ã¾ã€ã®ç›´æ„Ÿçš„ãªãƒªã‚ºãƒ å…¥åŠ›**

æ¥½è­œä¸Šã§ç›´æ¥ãƒãƒ¼ãƒˆã‚’é…ç½®ãƒ»ç·¨é›†ã™ã‚‹ã“ã¨ã§ã€
æ­£ç¢ºã‹ã¤ç›´æ„Ÿçš„ã«ãƒªã‚ºãƒ ã‚’ä½œæˆã§ãã‚‹ã€‚

## ä¸»è¦æ©Ÿèƒ½

### 1. äº”ç·šè­œä¸Šã§ã®ãƒãƒ¼ãƒˆé…ç½®
- **ã‚¯ãƒªãƒƒã‚¯ã§é…ç½®**: äº”ç·šè­œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã«ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
- **éŸ³ä¾¡ã®é¸æŠ**: ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆã§å…¨éŸ³ç¬¦ã€äºŒåˆ†éŸ³ç¬¦ã€å››åˆ†éŸ³ç¬¦ã€å…«åˆ†éŸ³ç¬¦ã€åå…­åˆ†éŸ³ç¬¦ã‚’é¸æŠ
- **ä¼‘ç¬¦ã®é…ç½®**: ä¼‘ç¬¦ã‚‚åŒæ§˜ã«é…ç½®å¯èƒ½
- **ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•**: é…ç½®ã—ãŸãƒãƒ¼ãƒˆã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’èª¿æ•´

### 2. è¤‡æ•°å°ç¯€å¯¾å¿œ
- **å°ç¯€ã®è¿½åŠ /å‰Šé™¤**: å‹•çš„ã«å°ç¯€ã‚’è¿½åŠ ãƒ»å‰Šé™¤
- **å°ç¯€ã”ã¨ã®æ‹å­è¨­å®š**: å„å°ç¯€ã«ç•°ãªã‚‹æ‹å­ã‚’è¨­å®šå¯èƒ½ï¼ˆåˆæœŸã¯å…¨ã¦4/4ï¼‰
- **ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ**: é•·ã„æ¥½è­œã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¡¨ç¤º

### 3. ãƒªã‚ºãƒ å†ç”Ÿ
- **Web Audio API**: ä¸€å®šã®éŸ³é«˜ï¼ˆä¾‹: 440Hzï¼‰ã§ãƒªã‚ºãƒ ã‚’å†ç”Ÿ
- **BPMèª¿æ•´**: 40ã€œ240ã®ç¯„å›²ã§ãƒ†ãƒ³ãƒå¤‰æ›´
- **å†ç”Ÿä¸­ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: ç¾åœ¨å†ç”Ÿä¸­ã®ãƒãƒ¼ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ

### 4. ç·¨é›†æ©Ÿèƒ½
- **å‰Šé™¤**: ãƒãƒ¼ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯/é¸æŠã—ã¦å‰Šé™¤
- **ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ**: ãƒãƒ¼ãƒˆã‚„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚³ãƒ”ãƒ¼
- **Undo/Redo**: æ“ä½œã®å–ã‚Šæ¶ˆã—ã¨ã‚„ã‚Šç›´ã—

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
// æ—¢å­˜ã®å‹ã‚’æ‹¡å¼µ
interface RhythmNote {
  id: string
  startBeat: number
  durationBeats: number
  isRest: boolean
}

interface Measure {
  id: string
  timeSignature: TimeSignature
  chord?: string
  notes: RhythmNote[]
  beatsPerMeasure: number  // 4/4ãªã‚‰4ã€3/4ãªã‚‰3
}

interface Score {
  id: string
  title: string
  tempo: number  // BPM
  measures: Measure[]
}

// æ–°ã—ã„å‹
interface NoteTemplate {
  type: 'whole' | 'half' | 'quarter' | 'eighth' | 'sixteenth'
  durationBeats: number
  isRest: boolean
}
```

## UIè¨­è¨ˆ

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
```
+--------------------------------------------------+
|  [ã‚¢ãƒ‰ãƒªãƒ–ãƒ¡ãƒ¼ã‚«ãƒ¼]                               |
+--------------------------------------------------+
|  BPM: [120 â–¼]  æ‹å­: [4/4 â–¼]  [â–¶ å†ç”Ÿ] [â¹ åœæ­¢] |
+--------------------------------------------------+
|  ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆ:                                  |
|  [ğ…] [ğ…—ğ…¥] [â™©] [â™ª] [â™¬]  [ä¼‘ç¬¦]  [å‰Šé™¤]            |
+--------------------------------------------------+
|                                                  |
|  äº”ç·šè­œã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰                   |
|  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      |
|  â”‚ [å°ç¯€1]  [å°ç¯€2]  [å°ç¯€3]  [+è¿½åŠ ]    â”‚      |
|  â”‚ â•â•â•â•â•â•â•  â•â•â•â•â•â•â•  â•â•â•â•â•â•â•           â”‚      |
|  â”‚                                      â”‚      |
|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      |
|                                                  |
+--------------------------------------------------+
```

### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

#### ãƒãƒ¼ãƒˆé…ç½®
1. ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆã§éŸ³ä¾¡ã‚’é¸æŠï¼ˆä¾‹: å››åˆ†éŸ³ç¬¦ï¼‰
2. äº”ç·šè­œä¸Šã®é…ç½®ã—ãŸã„ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯
3. é¸æŠã—ãŸéŸ³ä¾¡ã®ãƒãƒ¼ãƒˆãŒé…ç½®ã•ã‚Œã‚‹
4. ã‚°ãƒªãƒƒãƒ‰ã«ã‚¹ãƒŠãƒƒãƒ—ï¼ˆ16åˆ†éŸ³ç¬¦å˜ä½ï¼‰

#### ãƒãƒ¼ãƒˆç·¨é›†
- **å·¦ã‚¯ãƒªãƒƒã‚¯**: é¸æŠ
- **ãƒ‰ãƒ©ãƒƒã‚°**: ç§»å‹•
- **å³ã‚¯ãƒªãƒƒã‚¯/Deleteã‚­ãƒ¼**: å‰Šé™¤
- **ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯**: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç·¨é›†ï¼ˆå°†æ¥çš„ã«ï¼‰

#### å°ç¯€ç®¡ç†
- **å°ç¯€ã®è¿½åŠ **: æœ€å¾Œã®å°ç¯€ã®å³ã«ã‚ã‚‹ã€Œ+è¿½åŠ ã€ãƒœã‚¿ãƒ³
- **å°ç¯€ã®å‰Šé™¤**: å°ç¯€ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œå‰Šé™¤ã€
- **æ‹å­å¤‰æ›´**: å°ç¯€ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ æ‹å­è¨˜å·ã‚’å¤‰æ›´

## æŠ€è¡“å®Ÿè£…

### 1. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªäº”ç·šè­œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// src/ui/InteractiveStaff.tsx
interface InteractiveStaffProps {
  measures: Measure[]
  selectedTool: NoteTemplate | null
  onAddNote: (measureId: string, beat: number, template: NoteTemplate) => void
  onDeleteNote: (noteId: string) => void
  onMoveNote: (noteId: string, newBeat: number) => void
}
```

**å®Ÿè£…æ–¹é‡**:
- VexFlowã§æç”»ã—ãŸå¾Œã€é€æ˜ãªSVGè¦ç´ ã‚’é‡ã­ã¦ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
- ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‹ã‚‰ãƒ“ãƒ¼ãƒˆä½ç½®ã‚’è¨ˆç®—
- ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—å‡¦ç†

### 2. åº§æ¨™ â†’ ãƒ“ãƒ¼ãƒˆå¤‰æ›

```typescript
function clickPositionToBeat(
  x: number,
  measureWidth: number,
  measureStartBeat: number,
  beatsPerMeasure: number
): number {
  const relativeX = x % measureWidth
  const beat = (relativeX / measureWidth) * beatsPerMeasure + measureStartBeat
  return quantizeToGrid(beat)
}
```

### 3. å†ç”Ÿã‚¨ãƒ³ã‚¸ãƒ³

```typescript
// src/logic/audioPlayer.ts
class RhythmPlayer {
  private audioContext: AudioContext
  private scheduledNotes: number[] = []

  constructor(tempo: number) {
    this.audioContext = new AudioContext()
  }

  play(measures: Measure[], tempo: number): void {
    const beatDuration = 60 / tempo
    let currentTime = this.audioContext.currentTime

    measures.forEach(measure => {
      measure.notes.forEach(note => {
        if (!note.isRest) {
          this.scheduleNote(currentTime + note.startBeat * beatDuration, 0.1)
        }
      })
    })
  }

  private scheduleNote(time: number, duration: number): void {
    const oscillator = this.audioContext.createOscillator()
    const gainNode = this.audioContext.createGain()

    oscillator.connect(gainNode)
    gainNode.connect(this.audioContext.destination)

    oscillator.frequency.value = 440  // A4
    gainNode.gain.value = 0.3

    oscillator.start(time)
    oscillator.stop(time + duration)
  }

  stop(): void {
    // å†ç”Ÿä¸­ã®éŸ³ã‚’åœæ­¢
  }
}
```

## é–‹ç™ºã‚¹ãƒ†ãƒƒãƒ—

### Step 1: åŸºæœ¬çš„ãªãƒãƒ¼ãƒˆé…ç½®
- [ ] ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆUI
- [ ] ã‚¯ãƒªãƒƒã‚¯ä½ç½® â†’ ãƒ“ãƒ¼ãƒˆå¤‰æ›
- [ ] ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—
- [ ] ãƒãƒ¼ãƒˆã®è¿½åŠ ãƒ»å‰Šé™¤

### Step 2: è¤‡æ•°å°ç¯€å¯¾å¿œ
- [ ] å°ç¯€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®Ÿè£…
- [ ] å°ç¯€ã®è¿½åŠ ãƒ»å‰Šé™¤UI
- [ ] å°ç¯€ã¾ãŸãã®æç”»

### Step 3: å†ç”Ÿæ©Ÿèƒ½
- [ ] Web Audio APIã«ã‚ˆã‚‹éŸ³å£°å†ç”Ÿ
- [ ] BPMèª¿æ•´
- [ ] å†ç”Ÿ/åœæ­¢ãƒœã‚¿ãƒ³
- [ ] å†ç”Ÿä½ç½®ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

### Step 4: ç·¨é›†æ©Ÿèƒ½ã®å……å®Ÿ
- [ ] ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
- [ ] ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ
- [ ] Undo/Redo
- [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

## æœŸå¾…ã•ã‚Œã‚‹åˆ©ç‚¹

1. **æ­£ç¢ºæ€§**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ„å›³ã—ãŸé€šã‚Šã®ãƒªã‚ºãƒ ã‚’é…ç½®
2. **è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: é…ç½®ã—ãŸãƒãƒ¼ãƒˆãŒã™ãã«ç¢ºèªã§ãã‚‹
3. **æŸ”è»Ÿæ€§**: è¤‡é›‘ãªãƒªã‚ºãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è‡ªç”±ã«ä½œæˆ
4. **å­¦ç¿’æ›²ç·š**: æ¥½è­œã®çŸ¥è­˜ãŒã‚ã‚Œã°ç›´æ„Ÿçš„ã«ä½¿ãˆã‚‹

### 5. PDFå‡ºåŠ›æ©Ÿèƒ½

**ç›®çš„**: ä½œæˆã—ãŸæ¥½è­œã‚’PDFã¨ã—ã¦ä¿å­˜ãƒ»å°åˆ·

#### å®Ÿè£…æ–¹æ³•

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: SVG â†’ PDFå¤‰æ›**
```typescript
// jsPDFã‚’ä½¿ç”¨
import jsPDF from 'jspdf'
import 'svg2pdf.js'

async function exportToPDF(score: Score): Promise<void> {
  const pdf = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: 'a4'
  })

  // VexFlowã§ç”Ÿæˆã—ãŸSVGè¦ç´ ã‚’å–å¾—
  const svgElement = document.querySelector('#staff-container svg')

  if (svgElement) {
    await pdf.svg(svgElement, {
      x: 10,
      y: 10,
      width: 277,  // A4æ¨ªå‘ãã®å¹…
      height: 190
    })
  }

  pdf.save(`${score.title}.pdf`)
}
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: CanvasçµŒç”±**
```typescript
import html2canvas from 'html2canvas'
import jsPDF from 'jspdf'

async function exportToPDF(score: Score): Promise<void> {
  const element = document.getElementById('staff-container')

  if (element) {
    const canvas = await html2canvas(element, {
      scale: 2,  // é«˜è§£åƒåº¦
      backgroundColor: '#ffffff'
    })

    const imgData = canvas.toDataURL('image/png')
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    })

    const imgWidth = 277
    const imgHeight = (canvas.height * imgWidth) / canvas.width

    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight)
    pdf.save(`${score.title}.pdf`)
  }
}
```

#### å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
```json
{
  "dependencies": {
    "jspdf": "^2.5.1",
    "svg2pdf.js": "^2.2.3"
  }
}
```

ã¾ãŸã¯

```json
{
  "dependencies": {
    "jspdf": "^2.5.1",
    "html2canvas": "^1.4.1"
  }
}
```

#### UIè¨­è¨ˆ
```typescript
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
<button onClick={handleExportPDF}>
  ğŸ“„ PDFå‡ºåŠ›
</button>
```

#### æ©Ÿèƒ½è©³ç´°
- **ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š**: PDFãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ç”¨
- **ãƒšãƒ¼ã‚¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**: è‡ªå‹•ã§è¤‡æ•°ãƒšãƒ¼ã‚¸ã«åˆ†å‰²ï¼ˆé•·ã„æ¥½è­œã®å ´åˆï¼‰
- **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: ä½œæˆæ—¥æ™‚ã€BPMã€æ‹å­ãªã©ã‚’PDFã«åŸ‹ã‚è¾¼ã¿
- **å°åˆ·æœ€é©åŒ–**: é«˜è§£åƒåº¦ã§å‡ºåŠ›

## ä»Šå¾Œã®æ‹¡å¼µå¯èƒ½æ€§

- **éŸ³é«˜ã®è¿½åŠ **: ãƒªã‚ºãƒ ã ã‘ã§ãªããƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ã‚‚å…¥åŠ›
- **è¤‡æ•°ãƒˆãƒ©ãƒƒã‚¯**: ãƒ‰ãƒ©ãƒ ã€ãƒ™ãƒ¼ã‚¹ã€ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ãªã©
- **ä»–ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼**: MIDIã€MusicXMLå½¢å¼ã§ä¿å­˜
- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: ã‚ˆãä½¿ã†ãƒªã‚ºãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **ã‚³ãƒ¼ãƒ‰é€²è¡Œ**: ãƒªã‚ºãƒ ã«ã‚³ãƒ¼ãƒ‰ã‚’ä»˜åŠ 
- **ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜**: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã®ä¿å­˜ãƒ»å…±æœ‰æ©Ÿèƒ½
